<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FreeMediaBuzz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="FreeMediaBuzz ‚Äì Download unlimited videos, images, audio, templates, and APKs completely free."
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>
    <div id="root"></div>

    <!-- Early History Guard - runs before any other scripts -->
    <script>
      (function() {
        'use strict';
        if (typeof window === 'undefined') return;
        
        // Log initial history state IMMEDIATELY (before anything else)
        const initialHistoryLength = window.history.length;
        console.log('[Early Guard] ‚ö° Running IMMEDIATELY on page load');
        console.log('[Early Guard] Initial history length:', initialHistoryLength);
        console.log('[Early Guard] Current URL:', window.location.href);
        
        // If history is already polluted, this is a serious problem
        if (initialHistoryLength > 10) {
          console.error('[Early Guard] ‚ùå CRITICAL: History length is', initialHistoryLength, 'on page load!');
          console.error('[Early Guard] This should be 1 after a hard refresh!');
          console.error('[Early Guard]');
          console.error('[Early Guard] Possible causes:');
          console.error('[Early Guard]   1. Browser session restore (check browser settings)');
          console.error('[Early Guard]   2. Service worker preserving state (check DevTools > Application > Service Workers)');
          console.error('[Early Guard]   3. Browser extension interfering');
          console.error('[Early Guard]');
          console.error('[Early Guard] üîß Try these solutions:');
          console.error('[Early Guard]   - Close ALL tabs of this site, then open new one');
          console.error('[Early Guard]   - Clear browser cache and cookies for this site');
          console.error('[Early Guard]   - Disable service workers (DevTools > Application > Service Workers > Unregister)');
          console.error('[Early Guard]   - Try incognito/private mode');
        } else {
          console.log('[Early Guard] ‚úÖ History length is normal:', initialHistoryLength);
        }
        
        // Store original pushState IMMEDIATELY
        const originalPushState = window.history.pushState;
        const originalReplaceState = window.history.replaceState;
        let lastUrl = window.location.pathname + window.location.search + window.location.hash;
        let lastPushTime = 0;
        let pushStateCallCount = 0;
        let replaceStateCallCount = 0;
        
        // Also monitor replaceState to see if something is using that
        window.history.replaceState = function(state, title, url) {
          replaceStateCallCount++;
          if (replaceStateCallCount <= 5) { // Log first 5 to avoid spam
            console.log('[Early Guard] replaceState call #' + replaceStateCallCount, {
              url: url || window.location.href,
              historyLength: window.history.length
            });
          }
          return originalReplaceState.call(window.history, state, title, url);
        };
        
        // Override pushState to block ALL same-URL duplicates (very aggressive)
        window.history.pushState = function(state, title, url) {
          pushStateCallCount++;
          const now = Date.now();
          const timeSinceLastPush = now - lastPushTime;
          lastPushTime = now;
          
          // Get URLs
          const currentUrl = window.location.pathname + window.location.search + window.location.hash;
          let newUrl = currentUrl;
          
          if (url) {
            const urlStr = String(url);
            if (urlStr.startsWith('http://') || urlStr.startsWith('https://')) {
              try {
                const urlObj = new URL(urlStr);
                newUrl = urlObj.pathname + urlObj.search + urlObj.hash;
              } catch { newUrl = currentUrl; }
            } else {
              try {
                const urlObj = new URL(urlStr, window.location.origin);
                newUrl = urlObj.pathname + urlObj.search + urlObj.hash;
              } catch { newUrl = urlStr.startsWith('/') ? urlStr : '/' + urlStr; }
            }
          }
          
          // Log EVERY pushState call to see what's creating duplicates
          const stack = new Error().stack || '';
          const isReactRouter = stack.includes('BrowserRouter') || 
                               stack.includes('react-router') || 
                               stack.includes('Router') ||
                               (state && typeof state === 'object' && ('key' in state || 'usr' in state));
          
          console.log('[Early Guard] pushState call #' + pushStateCallCount, {
            newUrl: newUrl,
            currentUrl: currentUrl,
            isSameUrl: newUrl === currentUrl,
            isReactRouter: isReactRouter,
            timeSinceLastPush: timeSinceLastPush + 'ms',
            historyLength: window.history.length,
            stack: stack.split('\n').slice(1, 4).join('\n') // First 3 stack frames
          });
          
          // Allow different URLs (legitimate navigation)
          if (newUrl !== currentUrl) {
            lastUrl = newUrl;
            console.log('[Early Guard] ‚úÖ ALLOWED - Different URL');
            return originalPushState.call(window.history, state, title, url);
          }
          
          // SAME URL - This creates a duplicate entry!
          // Block ALL same-URL pushState calls (not just rapid ones)
          // React Router should NEVER push the same URL - that's a bug
          console.warn('[Early Guard] ‚ùå BLOCKING duplicate (#', pushStateCallCount, ') - Same URL:', newUrl);
          console.warn('[Early Guard] Using replaceState instead to prevent duplicate history entry');
          return window.history.replaceState(state, title, url);
        };
        
        console.log('[Early History Guard] Active (inline script)');
        console.log('[Early Guard] Will log pushState call count on first call');
        
        // Expose utility to check history state
        if (typeof window !== 'undefined') {
          window.checkEarlyGuard = function() {
            console.log('[Early Guard] Current state:', {
              historyLength: window.history.length,
              currentUrl: window.location.href,
              pushStateCallCount: pushStateCallCount,
              replaceStateCallCount: replaceStateCallCount,
              lastUrl: lastUrl,
              note: pushStateCallCount === 0 && window.history.length > 10 
                ? '‚ö†Ô∏è History is polluted but no pushState calls detected - likely from previous session'
                : 'Normal'
            });
          };
          
          // Also expose a function to check if history is polluted
          window.isHistoryPolluted = function() {
            const length = window.history.length;
            if (length > 10) {
              console.error('[Early Guard] ‚ùå History is POLLUTED:', length, 'entries');
              console.error('[Early Guard] This prevents the back button from working');
              console.error('[Early Guard]');
              console.error('[Early Guard] üîß SOLUTION: Close ALL tabs and open a fresh one');
              return true;
            } else {
              console.log('[Early Guard] ‚úÖ History is clean:', length, 'entries');
              return false;
            }
          };
          console.log('[Early Guard] üí° Use window.checkEarlyGuard() to check guard state');
        }
      })();
    </script>

    <script type="module" src="/client/main.tsx"></script>
  </body>
</html>
